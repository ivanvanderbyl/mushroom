<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Mushroom by ivanvanderbyl</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>Mushroom</h1>
        <p>Super simple notification service for dispatching and responding to events within your application using a fanout exchange</p>
        <p class="view"><a href="https://github.com/ivanvanderbyl/mushroom">View the Project on GitHub <small>ivanvanderbyl/mushroom</small></a></p>
        <ul>
          <li><a href="https://github.com/ivanvanderbyl/mushroom/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/ivanvanderbyl/mushroom/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/ivanvanderbyl/mushroom">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h1>Mushroom</h1>

<p>Mushroom is a super simple wrapper around ActiveSupport Instrumentation introduced in Rails 3.</p>

<p>Mushroom allows any component of your application to trigger events which later get subscribed to by any
other component in your application.</p>

<p>The returned event can be used to handle follow up behaviour, profile running code, and event dispatch requests to
other services.</p>

<h2>Installation</h2>

<p>Add this line to your application's Gemfile:</p>

<pre><code>gem 'mushroom'
</code></pre>

<p>And then execute:</p>

<pre><code>$ bundle
</code></pre>

<p>Or install it yourself as:</p>

<pre><code>$ gem install mushroom
</code></pre>

<h2>Usage</h2>

<p><strong>Simple example: Dispatch an event and receive it somewhere else</strong></p>

<div class="highlight">
<pre>
<span class="c1"># app/models/server.rb</span>
<span class="k">class</span> <span class="nc">Server</span>
  <span class="kp">include</span> <span class="no">Mushroom</span>

  <span class="k">def</span> <span class="nf">run</span>
    <span class="n">notify</span> <span class="ss">:start</span> <span class="c1">#=&gt; Dispatches a 'server:start' event with the current server instance as the event target.</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># lib/my_app/event_handler.rb</span>
<span class="k">class</span> <span class="nc">EventHandler</span> <span class="o">&lt;</span> <span class="no">Mushroom</span><span class="o">::</span><span class="no">Subscriber</span>
  <span class="n">events</span> <span class="ss">:start</span><span class="p">,</span> <span class="ss">:on</span> <span class="o">=&gt;</span> <span class="no">Server</span>

  <span class="k">def</span> <span class="nf">notify</span>
    <span class="c1"># Handle event here</span>
    <span class="nb">puts</span> <span class="nb">name</span>     <span class="c1">#=&gt; "server:start"</span>
    <span class="nb">puts</span> <span class="n">target</span>   <span class="c1">#=&gt; &lt;Server id:1 ...&gt;</span>
    <span class="nb">puts</span> <span class="n">duration</span> <span class="c1">#=&gt; 0.001</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Server</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">run</span>
</pre>
</div>


<p><strong>Slightly more advanced example: Instrument a method running, and display its duration:</strong></p>

<div class="highlight">
<pre><span class="k">class</span> <span class="nc">Server</span>
  <span class="kp">include</span> <span class="no">Mushroom</span>

  <span class="k">def</span> <span class="nf">start</span>
    <span class="nb">sleep</span> <span class="mi">1</span>
  <span class="k">end</span>
  <span class="n">instrument</span> <span class="ss">:start</span>
<span class="k">end</span>

<span class="c1"># lib/my_app/event_handler.rb</span>
<span class="k">class</span> <span class="nc">EventHandler</span> <span class="o">&lt;</span> <span class="no">Mushroom</span><span class="o">::</span><span class="no">Subscriber</span>
  <span class="n">events</span> <span class="ss">:start</span><span class="p">,</span> <span class="ss">:on</span> <span class="o">=&gt;</span> <span class="no">Server</span>

  <span class="k">def</span> <span class="nf">notify</span>
    <span class="c1"># Handle event here</span>
    <span class="nb">puts</span> <span class="nb">name</span>     <span class="c1">#=&gt; "server:start"</span>
    <span class="nb">puts</span> <span class="n">target</span>   <span class="c1">#=&gt; &lt;Server id:1 ...&gt;</span>
    <span class="nb">puts</span> <span class="n">duration</span> <span class="c1">#=&gt; 1000.0</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Server</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">start</span>
</pre>
</div>


<p><strong>Subscribing to multiple events:</strong></p>

<div class="highlight">
<pre><span class="c1"># lib/my_app/event_handler.rb</span>
<span class="k">class</span> <span class="nc">EventHandler</span> <span class="o">&lt;</span> <span class="no">Mushroom</span><span class="o">::</span><span class="no">Subscriber</span>
  <span class="n">events</span> <span class="ss">:start</span><span class="p">,</span> <span class="ss">:stop</span><span class="p">,</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="ss">:on</span> <span class="o">=&gt;</span> <span class="no">Server</span>
<span class="k">end</span>
</pre>
</div>


<p><strong>Subscribing events to multiple targets</strong></p>

<div class="highlight">
<pre><span class="c1"># lib/my_app/event_handler.rb</span>
<span class="k">class</span> <span class="nc">EventHandler</span> <span class="o">&lt;</span> <span class="no">Mushroom</span><span class="o">::</span><span class="no">Subscriber</span>
  <span class="n">events</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="ss">:on</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="no">Server</span><span class="p">,</span> <span class="no">User</span><span class="p">,</span> <span class="no">Account</span><span class="o">]</span>
<span class="k">end</span>
</pre>
</div>


<p><strong>Passing extra parameters to the subscriber</strong></p>

<div class="highlight">
<pre><span class="k">class</span> <span class="nc">Server</span>
  <span class="kp">include</span> <span class="no">Mushroom</span>

  <span class="k">def</span> <span class="nf">start</span>
    <span class="n">notify</span> <span class="ss">:start</span><span class="p">,</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># lib/my_app/event_handler.rb</span>
<span class="k">class</span> <span class="nc">EventHandler</span> <span class="o">&lt;</span> <span class="no">Mushroom</span><span class="o">::</span><span class="no">Subscriber</span>
  <span class="n">events</span> <span class="ss">:start</span><span class="p">,</span> <span class="ss">:on</span> <span class="o">=&gt;</span> <span class="no">Server</span>

  <span class="k">def</span> <span class="nf">notify</span><span class="p">(</span><span class="n">started_at</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="n">started_at</span> <span class="c1">#=&gt; 2012-04-26 16:56:54 +1000</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Server</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">start</span>
</pre>
</div>


<p>Remember to declare all the arguments you expect to be received in <code>#notify</code> or you won't receive them all. You can also get the same
arguments from the <code>#payload</code> method.</p>

<h2>Subscriber API</h2>

<p>The following methods are available on your Subscriber subclass:</p>

<div class="highlight">
<pre><span class="c1"># payload</span>
<span class="c1"># name</span>
<span class="c1"># time</span>
<span class="c1"># transaction_id</span>
<span class="c1"># duration</span>
</pre>
</div>


<h2>Contributing</h2>

<ol>
<li>Fork it</li>
<li>Create your feature branch (<code>git checkout -b my-new-feature</code>)</li>
<li>Commit your changes (<code>git commit -am 'Added some feature'</code>)</li>
<li>Push to the branch (<code>git push origin my-new-feature</code>)</li>
<li>Create new Pull Request</li>
</ol><h1>Author</h1>

<ul>
<li>Ivan Vanderbyl</li>
</ul>
      </section>
    </div>
    <footer>
      <p>Project maintained by <a href="https://github.com/ivanvanderbyl">ivanvanderbyl</a></p>
      <p>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></p>
    </footer>
    <!--[if !IE]><script>fixScale(document);</script><!--<![endif]-->
    
  </body>
</html>